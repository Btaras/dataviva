<!-- extend admin_template -->
{% extends "templates/admin.html" %}

{% block admin_content %}

{% if activity_type == "starred" %}
<h5>Starred <i class=" icon-star-empty"></i></h5>
{% elif activity_type == "questions" %}
<h5>Questions</h5>
{% elif activity_type == "replies" %}
<h5>Replies</h5>
{% else %}
<h5>History</h5>
{% endif %}
<hr class="bold"/>

<div class="feed"></div>

<script src="/static/js/utils/utils.infinite_scroll.js"></script>
<script>

// clean up data into one nice array of activities
// activities = new_data.activities.map(function(d){
//   return_obj = d[1]
//   return_obj["activity_type"] = d[0]
//   return_obj["title"] = d[1].app_name ? d[1].app_name : d[1].question ? d[1].question : d[1].body;
//   return_obj["timestamp"] = parseDate(d[1].timestamp);
//   return return_obj
// });


function item_formatter(container_el, activities){
  
  var formatDate = d3.time.format("%B %-d, %Y"),
      parseDate = d3.time.format.iso.parse;
  
  var activities_enter = d3.select(container_el).selectAll(".activity")
    .data(activities, function(d){ return d[1].app_id; })
    .enter().insert("a", "div.loading")
      .attr("class", "activity")
      .attr("href", function(d){
        var url = "#"
        if(d[0] == "starred"){
          url = "/embed/" + d[1].app_id;
        }
        else if(d[0] == "questions"){
          url = "/ask/question/" + d[1].slug;
        }
        else if(d[0] == "replies"){
          url = "/ask/question/" + d[1].question_id;
        }
        return url;
      })
      .append("div")
      .attr("class", "feed-item")
  
  // the title div housing the icon and title
  var title_div = activities_enter.append("div")
      .attr("class", "feed_title")
  
  // add icon
  title_div.append("img")
    .attr("src", function(d){
      var img_url = "/static/img/icons/tiles/";
  
      // if this is a starred app, we need to figure out which app it is
      // and use this app's icon
      if(d[0] == "starred"){
        var app_type = d[1].app_id.split("/")[0]
        img_url += app_type+"_tile.png";
      }

      // otherwise it's an ask sabrina question/reply
      else {
        if(d[0] == "questions"){
          img_url += "question_tile.png";
        }
        else {
          img_url += "reply_tile.png";
        }
      }
      return img_url
    })
    .attr("width", "23px")
    .attr("padding-bottom", "23px")

    // the title (strip out HTML!)
    title_div.append("p")
      .html(function(d){
        var title = d[1].app_name ? d[1].app_name : d[1].question ? d[1].question : d[1].body;
        return title.replace(/(<([^>]+)>)/ig,"");
      })
      
    // lastly, the div that holds the data
    activities_enter.append("div")
        .attr("class", "feed_date")
        .text(function(d) { 
          return formatDate(parseDate(d[1].timestamp)); 
        });

}

var is = infinite_scroll()
          .format_items(item_formatter);

d3.select(".feed")
  .call(is)

</script>

{% endblock %}