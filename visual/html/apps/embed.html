<!-- extend from base layout -->
{% extends "templates/base.html" %}

{% block head %}

  <link type="text/css" rel="stylesheet" media="all" href="/static/css/styles.apps.css" />
  <link type="text/css" rel="stylesheet" media="all" href="/static/css/utils/utils.key.css" />
  <link type="text/css" rel="stylesheet" media="all" href="/static/css/utils/utils.selector.css" />
  
  <!--[if lt IE 9]>
  <script type="text/javascript" src="/static/js/libs/aight.d3.min.js?v=3"></script>
  <![endif]-->

{% endblock %}


{% block content %}

  <div id="mask" class="loading"></div>

  <div id="builder">

    <select id="app_select" onchange="builder.app(this.options[this.selectedIndex].id)">
      {% set pre_app = None %}
      {% for build in all_builds %}

        {% if pre_app != build.app.type %}
          {% set pre_app = build.app.type %}
          <option icon="url('/static/img/icons/app/app_{{build.app.type}}.png')" color="{{build.app.color}}" value="{{build.app.type}}" id="{{build.app.type}}"{% if build.app.type == current_build.app.type %} selected="selected"{% endif %}>
              {{ build.app.title }}
          </option>
        {% endif %}

      {% endfor %}
    </select>
    
    <div id="output" class="leon button" onclick="builder.selector(this.id)">
      <span class="list_text">{% trans %}Change Output{% endtrans %}</span>
      <i class="icon-list-alt"></i>
    </div>

    <div id="bra_0" class="leon button" onclick="builder.selector(this.id)">
      {% set bra = current_build.bra[0] %}
      <div class="leon icon" style="background-color:{{ bra.color }}; background-image:url('{{ bra.icon }}')"></div>
      <span class="list_text">{{ bra.name() }}</span>
      <i class="icon-list-alt"></i>
    </div>
    
    {% if current_build.bra[1] %}
    {% set bra = current_build.bra[1] %}
    {% endif %}
    <div id="bra_1" class="leon button" onclick="builder.selector(this.id)">
      <div class="leon icon"{% if bra %} style="background-color:{{ bra.color }}; background-image:url('{{ bra.icon }}')"{% endif %}></div>
      <span class="list_text">{% if bra %}{{ bra.name() }}{% endif %}</span>
      <i class="icon-list-alt"></i>
    </div>
    
    {% if current_build.isic %}
    {% set isic = current_build.isic[0] %}
    {% endif %}
    <div id="isic_0" class="leon button" onclick="builder.selector(this.id)">
      <div class="leon icon"{% if isic %} style="background-color:{{ isic.color }}; background-image:url('/static/img/icons/isic/isic_{{ isic.id[:1] }}.png')"{% endif %}></div>
      <span class="list_text">{% if isic %}{{ isic.name() }}{% endif %}</span>
      <i class="icon-list-alt"></i>
    </div>

    {% if current_build.cbo %}
    {% set cbo = current_build.cbo[0] %}
    {% endif %}
    <div id="cbo_0" class="leon button" onclick="builder.selector(this.id)">
      <div class="leon icon"{% if cbo %} style="background-color:{{ cbo.color }}; background-image:url('/static/img/icons/cbo/cbo_{{ cbo.id[:1] }}.png')"{% endif %}></div>
      <span class="list_text">{% if cbo %}{{ cbo.name() }}{% endif %}</span>
      <i class="icon-list-alt"></i>
    </div>

    {% if current_build.hs %}
    {% set hs = current_build.hs[0] %}
    {% endif %}
    <div id="hs_0" class="leon button" onclick="builder.selector(this.id)">
      <div class="leon icon"{% if hs %} style="background-color:{{ hs.color }}; background-image:url('/static/img/icons/hs/hs_{{ hs.id[:2] }}.png')"{% endif %}></div>
      <span class="list_text">{% if hs %}{{ hs.name() }}{% endif %}</span>
      <i class="icon-list-alt"></i>
    </div>

    {% if current_build.wld %}
    {% set wld = current_build.wld[0] %}
    {% endif %}
    <div id="wld_0" class="leon button" onclick="builder.selector(this.id)">
      <div class="leon icon"{% if wld %} style="background-color:{{ wld.color }}; background-image:url('/static/img/icons/wld/wld_{{ wld.id }}.png')"{% endif %}></div>
      <span class="list_text">{% if wld %}{{ wld.name() }}{% endif %}</span>
      <i class="icon-list-alt"></i>
    </div>
    
    <div id="app_controls"></div>
  
  </div>

  <div id="settings">

    <a id="refresh" class="leon button square" onclick="app.start()" onmouseover="visual.ui.tooltip(this.id,true)" onmouseout="visual.ui.tooltip(this.id,false)" alt="{% trans %}Refresh the App{% endtrans %}"><i class="icon-refresh"></i></a>
    <a id="file" class="leon button square" onclick="builder.selector(this.id)" onmouseover="visual.ui.tooltip(this.id,true)" onmouseout="visual.ui.tooltip(this.id,false)" alt="{% trans %}Download this App{% endtrans %}"><i class="icon-save"></i></a>
    <a id="starred" class="leon button square" onclick="app.star()" onmouseover="visual.ui.tooltip(this.id,true)" onmouseout="visual.ui.tooltip(this.id,false)" alt="{% trans %}Save this App{% endtrans %}"><i id="status_{{starred}}" class="{% if starred == 1 %}icon-star{% else %}icon-star-empty{% endif %}"></i></a>
    <a id="help" class="leon button square" onclick="builder.selector(this.id)" onmouseover="visual.ui.tooltip(this.id,true)" onmouseout="visual.ui.tooltip(this.id,false)" alt="{% trans %}Show App Tutorial{% endtrans %}"><i class="icon-question-sign"></i></a>
    <a id="full_screen" class="leon button square" onclick="window.open(window.location.href,'_blank')" onmouseover="visual.ui.tooltip(this.id,true)" onmouseout="visual.ui.tooltip(this.id,false)" alt="{% trans %}Open App in Full-Screen{% endtrans %}"><i class="icon-fullscreen"></i></a>
    <a id="controls_toggle" class="leon button square" onclick="builder.controls()" onmouseover="visual.ui.tooltip(this.id,true)" onmouseout="visual.ui.tooltip(this.id,false)" alt="{% trans %}Show/Hide Controls{% endtrans %}"><i class="icon-cogs"></i></a>
  
  </div>

  <div id="app"></div>
  <div id="ui_bottom"></div>
  
  <!-- Hidden <FORM> to submit the SVG data to the server, which will convert it 
       to SVG/PDF/PNG downloadable file. -->
  <form id="svgform" action="/data/download/" method="post">
    {{ form.hidden_tag() }}
  </form>

{% endblock %}

{% block js %}

  <script src="/static/js/libs/d3.geo.tile.js"></script>
  <script src="/static/js/libs/topojson.js"></script>
  <script src="/static/js/libs/queue.min.js"></script>
  <script src="/static/js/libs/jfont-minified.js"></script>
  <script src="/static/js/utils/utils.key.js"></script>
  <script src="/static/js/utils/utils.selector.js"></script>
  
  <script type="text/javascript">
    
    var loading = new visual.ui.loading("body")
    loading.color("#ffffff")
  
    loading.text("Initializing App").show()
    
    d3.select("#mask").remove()
  
    // App Data Formatting
    var format = {
      "occugrid": "occugrid",
      "compare": "compare",
      "geo_map": "default",
      "scatter": "default",
      "network": "default",
      "rings": "default",
      "tree_map": "default",
      "stacked": "default"
    }
    
    // Get various depth levels
    var depths = {
      "isic": visual.depths("isic"), 
      "cbo": visual.depths("cbo"),
      "hs": visual.depths("hs"),
      "bra": visual.depths("bra"),
      "bra2": visual.depths("bra"),
      "wld": visual.depths("wld")
    }
    
    // Create Filter Selector
    var selector = Selector()
      .popover(true);
    
    visual.popover.create({
      "id": "popover",
      "width": 600,
      "height": "80%"
    })
    
    leon("#app_select")
    
    // Hide full-screen button while in full-screen
    if (parent.location.pathname.indexOf("embed") >= 0) {
      d3.select("#full_screen").remove();
    }
    
    var footer = {
      "secex": visual.format.text("Data Provided by") + " SECEX",
      "rais": visual.format.text("Data Provided by") + " RAIS"
    }
    
    /*******************************/
    /* App Functions and Variables */
    /*******************************/
    
    var app = {}
    app.build = null
    app.url = "{{ current_build.url() }}"
    app.data = {}
    app.networks = {}
    app.coords = {}
    app.attrs = {}
    app.vars = {{ global_vars|safe }}
    app.solos = []
    app.filters = []
    
    if (app.vars.builder == "false") {
      app.vars.controls = "false"
      d3.select("#controls_toggle").remove()
    }
    
    // Set the max-width for the builder div and app_title
    app.title_width = window.innerWidth
    app.title_width -= d3.select("#settings").node().offsetWidth
    app.title_width -= 12
    d3.select("#builder")
      .style("max-width",app.title_width+"px")
      
    app.title_height = d3.select("#settings").node().offsetHeight+10
    
    app.font = null
    var fonts = ["HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", "Helvetica", "Arial", "sans-serif"]
    fonts.forEach(function(font){
      if (checkfont(font) && !app.font) app.font = font
    })

    app.html = function(id,list) {
      
      var obj = app.attrs[app.build.output][id]
      
      if (app.build.app.type == "rings") {
        if (list) {
          var cats = []
          list.forEach(function(n){
            var id = n[app.build.output+"_id"].slice(0,depths[app.build.output][0])
            if (cats.indexOf(id) < 0) cats.push(id)
          })
          builder.key(cats)
        }
        var old_url = app.url
        builder.filter(obj,app.build.output+"_0",true)
        if (app.url != old_url) {
          d3.json("/apps/embed/"+app.url)
            .header("X-Requested-With", "XMLHttpRequest")
            .get(function(error,data){
              app.build = data.current_build
              builder.url()
              builder.outputs(data.all_builds)
              d3.select("#app").call(app.viz.title(app.build.title))
            })
        }
        
        var rec_url = app.url
      }
      else {
        var u = app.url.split("/")
        if (["hs","isic"].indexOf(app.build.output) >= 0) {
          var i = 3
        }
        else if (["wld","cbo"].indexOf(app.build.output) >= 0) {
          var i = 4
        }
        else {
          var i = 2
        }
        u[i] = id
        var rec_url = u.join("/")
      }
      
      rec_format = function(data) {

        var priority = ["both_filters","filter2","filter1","no_filters"],
            html_return = "",
            title = false
        
        priority.forEach(function(p,i){
          if (data[p]) {
            if (!title) {
              html_return += "<div class='title'>Related Apps</div>"
              title = true
            }
            else if (i == priority.length-1) {
              html_return += "<div class='title'>Other Apps</div>"
            }
            
            if (["network","rings","geo_map"].indexOf(app.build.app.type) >= 0) {
              var classname = "decision short icon"
            }
            else {
              var classname = "decision icon"
            }
            
            data[p].forEach(function(a){
              html_return += "<div id='"+a.url+"' class='"+classname+" "+a.app.type+"' "
              html_return += "onclick='app.start(this.id)'>"
              html_return += a.title
              html_return += "</div>"
            })
          }
        })
        return html_return
        
      }
      
      return {"url": "/apps/recommend/"+rec_url, "callback": rec_format}
      
    }
    
    app.tooltip = {"short": [
          "hs_id",
          "wld_id",
          "isic_id",
          "cbo_id",
          "id_ibge",
          "growth_val",
          "growth_val_total"
        ], "long": [
          "display_id",
          "growth_val",
          "growth_val_total",
          "rca",
          "rca_wld",
          "wage",
          "wage_avg",
          "num_emp",
          "num_est",
          "val_usd",
          "distance",
          "complexity",
          "cp_bra_0_wage",
          "cp_bra_0_wage_avg",
          "cp_bra_0_num_emp",
          "cp_bra_0_num_est",
          "cp_bra_0_val_usd",
          "cp_bra_0_distance",
          "cp_bra_0_complexity",
          "cp_bra_1_wage",
          "cp_bra_1_wage_avg",
          "cp_bra_1_num_emp",
          "cp_bra_1_num_est",
          "cp_bra_1_val_usd",
          "cp_bra_1_distance",
          "cp_bra_1_complexity",
          "employed",
          "elsewhere",
          "total",
          "required",
          "importance"
        ]}
    
    // Define global viz-whiz app parameters
    app.viz = vizwhiz.viz()
      .name_array(["name","display_id"])
      .nesting_aggs({
          "distance": "mean",
          "complexity": "mean",
          "rca": "mean",
          "wage_avg": "mean",
          "cp_bra_0_distance": "mean",
          "cp_bra_0_complexity": "mean",
          "cp_bra_0_rca": "mean",
          "cp_bra_0_wage_avg": "mean",
          "cp_bra_1_distance": "mean",
          "cp_bra_1_complexity": "mean",
          "cp_bra_1_rca": "mean",
          "cp_bra_1_wage_avg": "mean"
        })
      .text_var("name")
      .year_var("year")
      .tooltip_info(app.tooltip)
      .text_format(visual.format.text)
      .number_format(visual.format.number)
      .name_array(["name","display_id"])
      .background("#ffffff")
      .click_function(app.html)
      .font(app.font)
      .font_weight("lighter")
    
    // Start building a new app
    app.start = function(new_url) {
          
      // Hide popover
      visual.popover.hide()
      
      if (new_url) app.url = new_url
      loading.text("Building App").show(app.create)
      
    }
    
    app.create = function() {

      d3.select("#ui_bottom").selectAll("*").remove();
      d3.select("#app_controls").selectAll("*").remove();
      vizwhiz.tooltip.remove();
      
      d3.json("/apps/embed/"+app.url)
        .header("X-Requested-With", "XMLHttpRequest")
        .get(function(error,data){
          
          if (error) {
            app.error("Build Not Available")
          }
          else {
            
            if (app.build && app.build.app.type != data.current_build.app.type) {
              builder.app(data.current_build.app.type,true)
            }
            
            // Set public current build variable
            app.build = data.current_build
            builder.url()
            builder.outputs(data.all_builds)
            
            // Show/hide filters depending on build requirements
            var filters = ["bra_0","bra_1","isic_0","cbo_0","hs_0","wld_0"]
            filters.forEach(function(filter){
              var type = filter.split("_")[0],
                  index = filter.split("_")[1]
              if (app.build[type] && app.build[type][index]) {
                d3.select("#"+filter).style("display","inline-block")
                builder.filter(app.build[type][index],filter,true)
              }
              else {
                d3.select("#"+filter).style("display","none")
              }
            })
            
            // Remove unused global_vars
            uis = []
            app.build.ui.forEach(function(ui){
              if (ui.type == "years") uis.push("year")
              else uis.push(ui.type)
            })
            for (v in app.vars) {
              if (uis.indexOf(v) < 0 && ["controls","builder"].indexOf(v) < 0) {
                delete app.vars[v];
              }
            }
          
            /***************************************/
            /* Data Calls and External Files Queue */
            /***************************************/  
            
            var q = queue()
            
            if (!app.data[app.build.data_url]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.data_url] = {}
                    app.data[app.build.data_url].raw = d.data
                    callback(error,d)
                  })
              },"/"+app.build.data_url)
            }
            
            if (!app.attrs[app.build.output]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    var out = app.build.output
                    app.attrs[out] = {}
                    
                    d.data.forEach(function(a){
                      a[out+"_id"] = a.id
                      app.attrs[app.build.output][a.id] = a
                    })
                    
                    for (id in app.attrs[app.build.output]) {
                      var obj = app.attrs[app.build.output][id]
                      depths[out].forEach(function(d){
                        if (d <= obj.id.length) {
                          var id = obj[out+"_id"].slice(0, d)
                          obj[out+"_"+d] = {"name":app.attrs[app.build.output][id].name}
                          obj[out+"_"+d][out+"_id"] = id
                        }
                      })
                    }
                    
                    callback(error,d)
                  })
              },"/attrs/"+app.build.output)
            }
            
            if (["network","rings"].indexOf(app.build.app.type) >= 0 
                && !app.networks[app.build.output]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                  
                    d.edges.forEach(function(edge){
                      if (["hs","isic"].indexOf(app.build.output) >= 0) {
                        edge.source = d.nodes[edge.source]
                        edge.target = d.nodes[edge.target]
                      }
                      else {
                        edge.source = d.nodes.filter(function(n){ return n[app.build.output+"_id"] == edge.source })[0]
                        edge.target = d.nodes.filter(function(n){ return n[app.build.output+"_id"] == edge.target })[0]
                      }
                    })
                  
                    app.networks[app.build.output] = d
                    callback(error,d)
                  })
              },"/static/json/networks/network_"+app.build.output+".json")
            }
            
            if (app.build.app.type == "geo_map") {
              
              if (!app.land) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.land = d
                    callback(error,d)
                  })
                },"/static/json/coords/wld_land.json")
              }
              
              var state = app.build.bra[0].id.substr(0,2)
              if (!app.coords[state]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.coords[state] = d
                    callback(error,d)
                  })
                },"/static/json/coords/"+state+"_munic.json")
              }
              
            }
            
            if (app.build.app.type == "occugrid") {
              
              app.build.req_url = app.build.data_url
                .replace(app.build.bra[0].id,"all")
                
              if (!app.data[app.build.req_url]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.req_url] = {}
                    app.data[app.build.req_url].raw = d.data
                    callback(error,d)
                  })
                },"/"+app.build.req_url)
              }
                
              app.build.else_url = app.build.data_url
                .replace(app.build.isic[0].id,"all")
                
              if (!app.data[app.build.else_url]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.else_url] = {}
                    app.data[app.build.else_url].raw = d.data
                    callback(error,d)
                  })
                },"/"+app.build.else_url)
              }
              
            }
            
            q.awaitAll(check_data)
            
            function check_data() {

              if (app.build.app.type == "geo_map" && app.build.bra[0].id == "all") {
                app.error("Geo Map only available for States");
              }
              else {
        
                app.finish()
                
              }
              
            }
            
          }
        });
        
    }
    
    app.error = function(error) {
      console.log("[visual] ERROR: "+error)
      app.resize()
      loading.hide()
      d3.select("#app").call(app.viz.error(error))
    }
    
    app.finish = function() {
      
      // Format Data if it hasn't already been formatted
      if (!app.data[app.build.data_url][format[app.build.app.type]]) {
        app.format_data()
      }
      
      d3.select("#ui_bottom").selectAll("*").remove()
      d3.select("#app_controls").selectAll("*").remove()
      
      // Create Key
      if (app.build.app.type != "geo_map") {

        d3.select("#ui_bottom").append("div")
          .attr("id","key")
          .datum(app.attrs[app.build.output])
          .call(Key().type(app.build.output))
      }
      
      app.build.ui.forEach(function(ui){
        if (ui.type == "years") {
          
          // Determine current year
          if (!app.vars.year) {
            app.vars.year = ui.values[ui.values.length-1];
          }
          else if (ui.values.indexOf(app.vars.year) < 0) {
            var closest = null;
            ui.values.forEach(function(y){
              if (!closest || Math.abs(y-app.vars.year) 
                  < Math.abs(closest-app.vars.year)) {
                closest = y;
              }
            })
            app.vars.year = closest;
          }
          
          var year = d3.select("#ui_bottom").append("div")
            .attr("id","year_slider")
        
          year.append("input")
            .attr("type","range")
            .attr("onchange","app.update('year',this.value)")
            .attr("id","year")
            .attr("name","year")
            .attr("min",ui.values[0]+"")
            .attr("max",ui.values[ui.values.length-1]+"")
            .attr("value",app.vars.year+"")
            .attr("step","1")
        
          year.append("label")
            .attr("for","year")
            .html(visual.format.text("year"))
          
          leon("#year")
          
        }
        else {
          
          // Custom Titles
          if (ui.type == "value_var") {
            if (app.build.app.type == "geo_map") var title = "color"
            else var title = "sizing"
          }
          else var title = ui.type
        
          // Set Global Vars
          if (ui.type == "value_var") {
            if (app.build.app.type == "occugrid") var default_value = "importance"      
            else if (ui.values.indexOf("val_usd") >= 0) var default_value = "val_usd"
            else if (ui.values.indexOf("num_emp") >= 0) var default_value = "num_emp"
            else var default_value = ui.values[0]
          }
          else if (ui.type == "depth" && app.build.app.type == "tree_map") {
            if (app.build.output == "bra" && app.build.bra[0].id == "all") {
              var default_value = ui.values[0]
            }
            else {
              var default_value = ui.values[ui.values.length-1]
            }
          }
          else if (ui.type == "sort" && app.build.app.type == "stacked") {
            var default_value = "color"
          }
          else {
            var default_value = ui.values[0]
          }
          
          if(!app.vars[ui.type] || ui.values.indexOf(app.vars[ui.type]) < 0) {
            app.vars[ui.type] = default_value
          }
        
          if (ui.values.length > 1 && app.vars.builder != "false") {
            builder.radios({
              "data": ui.values,
              "title": title,
              "initial": app.vars[ui.type],
              "type": ui.type
            })
          }
          
        }
        
      })
      
      var total_width = 0,
          avail_width = app.title_width
      d3.selectAll("#app_controls > div")
        .each(function(){
          total_width += this.offsetWidth
        })
      d3.selectAll("#builder > br").remove()
      if (total_width > avail_width) {
        var w = 0, firstbreak = true
        d3.selectAll("#app_controls > div")
          .each(function(){
            if (w > avail_width/2) {
              if (firstbreak) {
                firstbreak = false
                var br = document.createElement("br")
                this.parentNode.parentNode.insertBefore(br,this.parentNode)
              }
              w = 0
              var br = document.createElement("br")
              this.parentNode.insertBefore(br,this)
            }
            w += this.offsetWidth
          })
      }
      
      var nesting = []
      depths[app.build.output].forEach(function(d){
        nesting.push(app.build.output+"_"+d)
      })
      
      builder.url()
      
      var color_var = app.vars.color_var ? app.vars.color_var : "color"
        
      /************************/
      /* Gloabl App Variables */
      /************************/
      app.viz.type(app.build.app.viz_whiz)
        .title(app.build.title)
        .color_var(color_var)
        .attrs(app.attrs[app.build.output])
        .spotlight(app.vars.spotlight)
        .nesting(nesting)
        .depth(app.vars.depth)
        .sort(app.vars.sort)
        .grouping(app.vars.grouping)
        .order(app.vars.order)
        .layout(app.vars.layout)
        .value_var(app.vars.value_var)
        .year(app.vars.year)
        .total_bar(app.total())
        .highlight(null)
        .id_var(app.build.output+"_id")
        .error(false)
        .data_source(footer[app.build.dataset])
        
      /******************************/
      /* Network Specific Variables */
      /******************************/  
      if (app.build.app.type == "network") {
        var av = app.build.output == "hs" ? app.vars.rca_scope : "bra_rca"
        app.viz
          .links(app.networks[app.build.output].edges)
          .nodes(app.networks[app.build.output].nodes)
          .active_var(av)
      } 
  
      /****************************/
      /* Rings Specific Variables */
      /****************************/
      else if (app.build.app.type == "rings") {
        var av = app.build.output == "hs" ? app.vars.rca_scope : "bra_rca"
        app.viz
          .links(app.networks[app.build.output].edges)
          .nodes(app.networks[app.build.output].nodes)
          .highlight(app.build[app.build.output][0].id)
          .active_var(av)
      }
  
      /******************************/
      /* Geo Map Specific Variables */
      /******************************/
      else if (app.build.app.type == "geo_map") {
        app.viz
          .coords(app.coords[app.build.bra[0].id.substr(0,2)])
          .map(app.land)
          .tiles(false)
      
        if (app.build.bra[0].id.length == 8) app.viz.highlight(app.build.bra[0].id)
    
      } 
  
      /******************************/
      /* Bubbles Specific Variables */
      /******************************/
      else if (app.build.app.type == "occugrid") {
        app.viz
          .active_var("employed")
      } 

      /******************************/
      /* Stacked Specific Variables */
      /******************************/
      else if (app.build.app.type == "stacked") {
        app.viz
          .xaxis_var("year")
          .xaxis_scale("linear")
          .yaxis_scale("linear")
      } 

      /******************************/
      /* Scatter Specific Variables */
      /******************************/
      else if (app.build.app.type == "scatter") {
        var av = app.build.output == "hs" ? app.vars.rca_scope : "bra_rca"
        app.viz
          .xaxis_var("distance")
          .yaxis_var("complexity")
          .xaxis_scale("linear")
          .yaxis_scale("linear")
          .mirror_axis(false)
          .spotlight(app.vars.spotlight)
          .active_var(av)
      } 
  
      /******************************/
      /* Compare Specific Variables */
      /******************************/
      else if (app.build.app.type == "compare") {
    
        app.viz
          .xaxis_var("cp_bra_1_"+app.vars.axes)
          .xaxis_scale(app.vars.scale)
          .yaxis_var("cp_bra_0_"+app.vars.axes)
          .yaxis_scale(app.vars.scale)
          .spotlight(false)
          .mirror_axis(true)
    
      }
      
      d3.select("#app")
        .html("")
        .datum(app.data[app.build.data_url][format[app.build.app.type]])

      if (app.build.app.type != "rings") builder.key()
      app.resize()
      loading.hide()
      
    }
    
    app.update = function(type,value) {
      
      if (type == "solo" || type == "filter") {
        
        app[type+"s"] = value
        
        var ids = []
        if (app.solos.length >= 1 && app.solos.length <= app.categories.length/2) {
          var prefix = "Showing only "
          ids = app.solos
        }
        else if (app.solos.length > app.categories.length/2) {
          var prefix = "Excluding "
          cats.forEach(function(c){
            if (app.solos.indexOf(c) < 0) ids.push(c)
          })
        }
        else if (app.filters.length >= 1 && app.filters.length <= app.categories.length/2) {
          var prefix = "Excluding "
          ids = app.filters
        }
        else if (app.filters.length > app.categories.length/2) {
          var prefix = "Showing only "
          cats.forEach(function(c){
            if (app.filters.indexOf(c) < 0) ids.push(c)
          })
        }
      
        var names = []
        ids.forEach(function(id){
          names.push(app.attrs[app.build.output][id].name)
        })
      
        if (names.length > 0) {
          var text = prefix
          names.forEach(function(n,i){
            if (i != 0 && names.length != 2) text += ", "
            if (i == names.length-1 && i != 0) text += " and "
            text += n
          })
          var sub = text
        }
        else {
          var sub = ""
        }
        
        d3.select("#app").call(app.viz[type](app[type+"s"]).sub_title(sub))
        
      }
      else {
        
        app.vars[type] = value
        builder.url()
        if (type == "year" && app.build.app.type != "rings") {
          builder.key()
          app.resize()
        }

        if (type == "axes") {
          d3.select("#app").call(app.viz.xaxis_var("cp_bra_1_"+value).yaxis_var("cp_bra_0_"+value))
        }
        else if (type == "scale") {
          d3.select("#app").call(app.viz.xaxis_scale(value).yaxis_scale(value)) 
        }
        else if (type == "rca_scope") {
          d3.select("#app").call(app.viz.active_var(value))
        }
        else if (type == "value_var") {
          d3.select("#app").call(app.viz[type](value).total_bar(app.total()))
        }
        else {
          d3.select("#app").call(app.viz[type](value))
        }
      }
    }
    
    app.format_data = function() {
      
      var data_obj = [],
          data = app.data[app.build.data_url],
          out = app.build.output,
          attr = app.attrs[out]
      
      if ("occugrid" == format[app.build.app.type]) {
        
        var years = app.build.ui.filter(function(f){return f.type == "years"})[0].values
        
        years.forEach(function(year){
          
          var year_data = data.raw.filter(function(d){ return d.year == year; });
          
          var req_filtered = app.data[app.build.req_url].raw.filter(function(d){ return d.year == year && d.required >= 0.6 }),
              req_ids = []
              
          req_filtered.forEach(function(d){
            req_ids.push(d[app.build.output+"_id"])
          })
          
          var industry_size = d3.sum(d3.values(req_filtered),function(d){ return Math.ceil(d.num_emp_med); }),
              location_total = d3.sum(d3.values(year_data),function(d){ 
                return req_ids.indexOf(d[app.build.output+"_id"]) >= 0 ? d.num_emp : null; 
              });
              
          req_filtered.forEach(function(d){
      
            var temp_obj = year_data.filter(function(dd){ return dd[out+"_id"] == d[out+"_id"] })[0]
            if (!temp_obj) {
              temp_obj = {"num_emp": 0, "wage": 0, "num_est": 0}
            }
            d.required_wage_avg = d.wage/d.num_emp
            d = vizwhiz.utils.merge(d,temp_obj)
          
            d.none = 1;
            d.category = attr[d[out+"_id"].slice(0,depths[out][0])].name

          
            if (location_total >= industry_size) d.total = Math.ceil((d.num_emp_med/industry_size)*location_total);
            else d.total = Math.ceil(d.num_emp_med);
          
            d.employed = d.num_emp ? d.num_emp : 0;
            if (d.employed/d.total >= 1) d.active = true;
            else d.active = false;
          
            var elsewhere = app.data[app.build.else_url].raw.filter(function(e){ return e.year == year && e[out+"_id"] == d[out+"_id"] })[0]
          
            if (!elsewhere) elsewhere = 0;
            else elsewhere = elsewhere.num_emp;
          
            d.elsewhere = elsewhere-d.employed
      
            d.display_id = visual.displayID(d[out+"_id"],out)
            d.icon = visual.icon(d[out+"_id"],out)
            
            if (d.wage && d.num_emp) d.wage_avg = d.wage/d.num_emp;

            get_keys(d)
          
            data_obj.push(d)
            
          })
          
        })
    
      }
      else if ("compare" == format[app.build.app.type]) {
        
        d3.nest()
          .key(function(d){return d.year})
          .key(function(d){return d[out+"_id"]})
          .rollup(function(leaves){
            if (leaves.length == 2) {
              var d = {}
              d.year = leaves[0].year
              d[out+"_id"] = leaves[0][out+"_id"]
              d.display_id = visual.displayID(d[out+"_id"],out)
              d.icon = visual.icon(d[out+"_id"],out)
              d.active = true
              
              leaves.forEach(function(leaf){
                if (leaf.wage && leaf.num_emp) leaf.wage_avg = leaf.wage/leaf.num_emp;
                for (key in leaf) {
                  if (key != "bra_id" && key != out+"_id") {
                    if (typeof leaf[key] === "number" && key != "year") {
                      if (!d[key]) d[key] = 0
                      d[key] += leaf[key]
                    }
                    if (leaf.bra_id == app.build.bra[0].id) var k = "cp_bra_0_"+key
                    else if (leaf.bra_id == app.build.bra[1].id) var k = "cp_bra_1_"+key
                    d[k] = leaf[key]
                  }
                }
              })

              get_keys(d)
              
              data_obj.push(d)
              
            }
          })
          .entries(data.raw)
      }
      else {
        
        data.raw.forEach(function(d){
          
          var obj = d
          
          obj.display_id = visual.displayID(obj[out+"_id"],out)
          
          obj.icon = visual.icon(obj[out+"_id"],out)
          
          if (obj.wage && obj.num_emp) obj.wage_avg = obj.wage/obj.num_emp;
          else obj.wage_avg = 0
          
          obj.active = obj.rca >=1 ? true : false;
          
          obj.bra_rca = obj.rca >=1 ? true : false;
          obj.wld_rca = obj.rca_wld >=1 ? true : false;

          get_keys(obj)
          
          data_obj.push(obj)
          
        })
        
      }
      
      data[format[app.build.app.type]] = data_obj;
      
      function get_keys(d) {
        if (!data.categories) data.categories = {}
        if (!data.categories[d.year]) data.categories[d.year] = []
        if (!data.categories.all) data.categories.all = []
        for (var key in d) { 
          if (key == out+"_id") {
            var parent = d[key].slice(0,depths[out][0])
            if (data.categories[d.year].indexOf(parent) < 0) data.categories[d.year].push(parent);
            if (data.categories.all.indexOf(parent) < 0) data.categories.all.push(parent);
          }
        }
      }
      
    }
    
    app.total = function() {

      var exclusions = [
            "complexity",
            "none",
            "importance",
            "wage_avg",
            "required_wage_avg",
            undefined
          ],
          val = app.vars.value_var
        
      if (exclusions.indexOf(val) >= 0) return false;
      
      return {"prefix": visual.format.text(
val)+": ", "suffix": ""};
        
    }
    
    app.resize = function() {
      
      var children = d3.select("#ui_bottom").node().childNodes,
          min_width = 0;
          
      for (i = 0; i < children.length; i++) {
        var w = children[i].offsetWidth;
        if (w > min_width) min_width = w;
      }
  
      if (window.innerWidth < min_width || window.innerHeight <= 400) {
        app.vars.controls = "false";
        d3.select("#ui_bottom").style("display","none")
        d3.select("#settings").style("display","none")
        d3.select("#builder").style("display","none")
      }
      else {
        d3.select("#ui_bottom").style("display","block")
        d3.select("#settings").style("display","block")
        d3.select("#builder").style("display","block")
      }

      d3.select("#builder").style("top",function(d){
        if (app.vars.controls != "false") var u = 0
        else var u = 1
        return "-"+((this.offsetHeight+5)*u)+"px"
      })
  
      if (app.vars.controls == "true") {
        d3.select("#controls_toggle").attr("class","leon button square active")
        var title_height = 0
      }
      else {
        d3.select("#controls_toggle").attr("class","leon button square")
        var title_height = app.title_height
      }

      app.height = window.innerHeight;
      app.height -= d3.select("#ui_bottom").node().offsetHeight
      if (app.vars.controls != "false") app.height -= d3.select("#builder").node().offsetHeight
      app.width = window.innerWidth-10;
      
      d3.select("#app")
        .style("height",app.height+"px")
        .style("width",app.width+"px")
        .style("top",function(d){
          if (app.vars.controls != "false") var u = 1
          else var u = 0
          return ((d3.select("#builder").node().offsetHeight)*u)+"px"
        })
        .call(app.viz
            .height(app.height)
            .width(app.width)
            .title_width(app.title_width)
            .title_height(title_height)
          )
      
    }
    
    app.star = function() {

      var id = d3.select("#starred > i").attr("id")
      var status = parseInt(id.split("_")[1],10)
      if (status == 0) {
        login();
      }
      else {
        
        var url = window.location.pathname.replace("embed","star")
          
        d3.json(url)
          .header("Content-type","application/x-www-form-urlencoded")
          .post("title="+app.build.title, function(error,data) {
            var status = data.success
            d3.select("#starred > i")
              .attr("id","status_"+status)
              .attr("class",function() {
                return status == 1 ? "icon-star" : "icon-star-empty";
              })
          })
      }
        
    }
    
    /*********************/
    /* Builder Functions */
    /*********************/
    
    var builder = {}
    builder.outputs = function(builds) {
      app.all_builds = builds
      

      app.all_builds.forEach(function(build){
        d3.select("#output_"+build.app.type).remove()
      })
      
      app.all_builds.forEach(function(build){
        
        if (d3.select("#output_"+build.app.type).empty()) {
          visual.popover.create({
            "id": "output_"+build.app.type,
            "width": 600,
            "height": "80%"
          })
          d3.select("#output_"+build.app.type)
            .style("padding","10px")
            .style("overflow-y","auto")
        }
        
        if (d3.select("#output_"+build.app.type).select("."+build.dataset).empty()) {
          d3.select("#output_"+build.app.type).append("div")
            .attr("class",build.dataset)
            .append("div")
              .attr("class","title")
              .text(visual.format.text(build.dataset))
        }
        
        d3.select("#output_"+build.app.type).select("."+build.dataset).append("div")
          .attr("id",build.url)
          .attr("class","output decision icon "+build.app.type)
          .html(build.title)
          .on(vizwhiz.evt.click,function(){
            app.start(this.id)
          })
        
      })
      
      if (d3.selectAll("#output_"+app.build.app.type+" .output")[0].length == 1) {
        d3.select("#output").style("display","none")
      }
      else {
        d3.select("#output").style("display","inline-block")
      }
      
    }
    
    builder.filter = function(obj,id,static) {

      var type = id.split("_")[0],
          index = id.split("_")[1],
          old_obj = app.build[type][index]
          new_name = obj.name ? obj.name : obj["name_"+visual.language]
          
      if (type == "bra") {
        var url_index = 2
      }
      else if (["hs","isic"].indexOf(type) >= 0) {
        var url_index = 3
      }
      else {
        var url_index = 4
      }
      
      app.build[type][index] = obj
      var url = app.url.split("/")
      var ids = url[url_index].split("+")
      ids[index] = obj.id
      url[url_index] = ids.join("+")
      url = url.join("/")
      app.url = url
      
      var button = d3.select("#"+id)
      
      if (type == "bra" && !obj.distance) obj.distance = 0

      if (!obj.icon) obj.icon = visual.icon(obj.id,type)
      
      button.select(".icon")
       .style("background-image","url("+obj.icon+")")
       .style("background-color",obj.color)
        
      if (obj.distance > 0 && type == "bra") new_name += " ("+obj.distance+"km)"

      button.select(".list_text").text(new_name)
      
      if (!static) {
        app.start(url)
      }
       
    }
    
    builder.app = function(app_name,static) {
      
      document.getElementById("app_select").value = app_name
      leon("#app_select")
      
      var options = d3.select("#output_"+app_name).selectAll(".output")
      
      if (options[0].length > 1) {
        d3.select("#output").style("display","inline-block")
      }
      else {
        d3.select("#output").style("display","none")
      }
      
      if (!static) {
      
        var match = null, backup = null
      
        options
          .each(function(d){
            var a = app.url.split("/")
            var s = this.id.split("/")
            if (!backup && s[s.length-1] == a[a.length-1]) backup = this.id
            a.shift()
            a = a.join("/")
            s.shift()
            s = s.join("/")
            if (a == s) match = this.id
          })
        
        if (!match) {
          if (backup) match = backup
          else match = options[0][0].id
        }
      
        app.start(match)
      }
      
    }
    
    builder.radios = function(obj) {
      
      var div = d3.select("#app_controls").append("div")
        .attr("class","ui_group")
        .attr("id",obj.title)
    
      div.append("legend")
        .attr("id",obj.title)
        .html(visual.format.text(
obj.title))
        
      obj.data.forEach(function(v,i){
        
        var button = div.append("input")
          .attr("type","radio")
          .attr("name",obj.title)
          .attr("value",obj.title+"+"+v)
          .attr("id",obj.title+"+"+v)
          .attr("onclick","app.update('"+obj.type+"',this.value.split('+')[1])")
          
        div.append("label")
          .attr("for",obj.title+"+"+v)
          .text(visual.format.text(
v))
      
        if (v == obj.initial) {
          button.node().checked = true
        }
        
      })

      leon("$"+obj.title)
      
    }
    
    builder.url = function() {
      
      document.title = "Visual : "+app.build.title;
                        
      window_url = app.url
      
      if (Object.keys(app.vars).length > 0) {
        window_url += "/?"
        url_vars = []
        for (v in app.vars) {
          if (v != "controls" || (v == "controls" && app.vars.builder != "false")) {
            url_vars.push(v + "=" + app.vars[v])
          }
        }
        window_url += url_vars.join("&");
      }
      
      if (Modernizr.history) {
        window.history.pushState(
          {'prev_request': "/apps/embed/"+window_url}, 
          "Visual : "+app.build.title, "/apps/embed/"+window_url
        )
        if (window != window.parent &&
            window.parent.location.pathname.indexOf("builder") >= 0) {
          window.parent.history.pushState(
            {'prev_request': "/apps/builder/"+window_url}, 
            "Visual : "+app.build.title, "/apps/builder/"+window_url
          )
        }
      } 
      else if (window.location.href.indexOf(window_url) < 0) {
        if (window.parent.location.pathname.indexOf("embed") >= 0) {
          window.location = "/apps/embed/"+window_url
        } else {
          window.location = "/apps/buuilder/"+window_url
        }
      }
        
    }
    
    builder.key = function(cats) {
      
      if ("geo_map" != app.build.app.type) {
        if (!cats) {
          if (app.build.app.type != "network") {
            if (app.build.app.type != "stacked") {
              var cats = app.data[app.build.data_url].categories[app.vars.year]
            }
            else {
              var cats = app.data[app.build.data_url].categories.all
            }
          }
          else {
            var cats = []
            app.networks[app.build.output].nodes.forEach(function(n){
              var id = n[app.build.output+"_id"].slice(0,depths[app.build.output][0])
              if (cats.indexOf(id) < 0) cats.push(id)
            })
          }
        }
        
        if (cats.length == 1) {
          d3.select("div#key").style("display","none")
        }
        else {
          d3.select("div#key").style("display","block")
      
          d3.selectAll("div.key_icon_container")
            .style("display",function(){
              var id = this.id.slice(3)
              return cats.indexOf(id) < 0 ? "none" : "inline-block";
            })
        }
      
        app.categories = cats
        
      }
        
    }
    
    builder.controls = function() {
      
      if (app.vars.controls == "false") {
        app.vars.controls = "true"
      } else {
        app.vars.controls = "false"
      }
      builder.url()
      app.resize()
      
    }
    
    builder.selector = function(id) {
      
      if (id == "output") {
        
        visual.popover.show("#output_"+app.build.app.type)
        
      }
      else {

        var s = id.split("_")
        var type = s[0]
        if (s[1]) var index = s[1]
      
        if (type == "help") {
          var init = app.build.app.type,
              callback = null
        }
        else if (type == "file") {
          var init = "all",
              callback = "app.download"
        }
        else {
          var init = app.build[type][index].id,
              callback = builder.filter
        }
    
        // if (app.build.bra[0].distance) {
  //         var dist = app.build.bra[0].distance
  //       }
  //       else {
  //         var dist = 0
  //       }

        selector
          .callback(callback)
          // .distance(dist)
          .initial_value(init)
          .type(id)
    
        d3.select("#popover")
          .call(selector);
      
        // Show popover
        visual.popover.show("#popover");
        
      }
        
    }
    
    /*****************/
    /* Page Resizing */
    /*****************/
    
    window.onresize = function() {
      if(this.resizeTO) clearTimeout(this.resizeTO);
      this.resizeTO = setTimeout(function() {
        app.resize()
      },500)
    }
    
    /************************/
    /* Initialize First App */
    /************************/
   app.start()
  
  </script>

{% endblock %}