<!-- extend admin_template -->
{% extends "templates/admin.html" %}

{% block admin_content %}
  {% if questions|length %} 
    {% for q in questions %} 
        <div class="pending_q">
          <h2><a href="{{ url_for('ask.answer', slug=q.slug) }}">{{ q.question }}</a></h2>
          <div class="question_body">
            {% if q.body %}
              <p>{{ q.body|safe }}</p>
            {% endif %}
            {% if tags|length %}
              <div class="labels">
                Tags:
                {% for t in tags %}
                <a class="tag" style="background-color: {{ t.color }};" rel="tag">
                  <span class="tag-icon" rel="{{ t.__class__.__name__ }}" title="{{ t.id }}"></span>
                  <span>Paraná&nbsp;&nbsp;</span>
                </a>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="posted"><img src="{{ q.user.avatar(20) }}"> Asked by {{q.user.nickname}} {{momentjs(q.timestamp).fromNow()}}</div><br />
          <div class="question_answer">
            {% if q.status_notes %}
              <p>{{ q.status_notes|safe }}</p>
            {% else %}
              <p><i class="icon-exclamation-sign"></i> <b>This question has not been answered yet!</b></p>
            {% endif %}
          </div>
          <p class="update">
      
            {% if q.status.name != "Rejected" %}
            <a class="reject button" href="{{ url_for('admin.question_edit', question_id=q.id, action='rejected') }}">
              Reject
            </a> 
            {% endif %}
      
            {% if status.name != "Pending" %}
            <a class="pending button" href="{{ url_for('admin.question_edit', question_id=q.id, action='pending') }}">Pending</a> 
            {% endif %}
      
            <a class="duplicate button" href="{{ url_for('admin.question_edit', question_id=q.id, action='duplicate') }}">
              Tag Duplicate
            </a> 
      
            <a class="approve button" href="{{ url_for('admin.question_edit', question_id=q.id, action='approved') }}">
              {% if status.name == "Approved" %}Update Answer
              {% else %}Approve
              {% endif %}
            </a>
          </p>
        </div>
        <hr />
    {% endfor %}
  {% else %}
    <p><i>There are currently no {{status.name}} questions!</i></p>
  {% endif %}
  
  <div class="pagination">
    {% if pagination.has_prev %} <a class="button" href="{{ url_for('admin.questions', status=status.name, page=pagination.page-1) }}">&laquo; Previous</a> {% endif %}
    {% for page in pagination.iter_pages() %}
      {% if page %}
        {% if page != pagination.page %}
          <a class="button" href="{{ url_for('admin.questions', status=status.name, page=page) }}">{{ page }}</a>
        {% else %}
          <strong class="button current_page">{{ page }}</strong>
        {% endif %}
      {% else %}
        <span class=ellipsis>…</span>
      {% endif %}
    {% endfor %}
    {% if pagination.has_next %}
      <a class="button" href="{{ url_for('admin.questions', status=status.name, page=pagination.page+1) }}">Next &raquo;</a>
    {% endif %}
  </div>

<!-- wysihtml5 parser rules -->
<script src="/static/js/libs/wysihtml5-parser_rules-advanced.js"></script>
<!-- wysihtml5 library -->
<script src="/static/js/libs/wysihtml5-0.3.0.min.js"></script>
<script>
// var editor = new wysihtml5.Editor("wysihtml5-textarea", { // id of textarea element
//   toolbar:      "wysihtml5-toolbar", // id of toolbar element
//   parserRules:  wysihtml5ParserRules, // defined in parser rules set 
//   stylesheets: ["/static/css/libs/wysihtml5.stylesheet.css"]
// });

d3.select("#status_list").on("change", function(){
  // tbr.parentNode.replaceChild(document.getElementById("stroke"), tbr)
  // d3.select("#status_list").node().options[3].text
  var url = this.form.action
  var selected_status = this.options[this.selectedIndex].text.toLowerCase();
  window.location = url + selected_status;
})

d3.selectAll(".update a").on(vizwhiz.evt.click, function(){

  // has the form already been loaded?
  var _this = this;
  var parent_container = d3.select(this.parentNode.parentNode);
  var status_notes_form = parent_container.select("form");
  if(status_notes_form.empty()){

    // make AJAX call to server to fetch form + question data
    d3.html(this.href, function(status_notes_html){
      // console.log(d3.select(reject_form_html))

      // append form to page
      parent_container.node().appendChild(status_notes_html);
      // set action attribute
      parent_container.select("form").attr("action", _this.href);
      // TODO: set title for notes
      // parent_container.select("form h3").text("Answer:");

      // set up wysihtml5 editor (rich text) on text area
      var editor = new wysihtml5.Editor("wysihtml5-textarea", { // id of textarea element
        toolbar:      "wysihtml5-toolbar", // id of toolbar element
        parserRules:  wysihtml5ParserRules, // defined in parser rules set 
        stylesheets: ["/static/css/libs/wysihtml5.stylesheet.css"]
      });
    })
  }
  
  else {
    status_notes_form.remove()
  }

  d3.event.preventDefault();

})

// add icons to tags!
d3.selectAll(".tag-icon").style("background-image", function(){
  var tag_el = d3.select(this);
  return "url('"+dataminas.icon(tag_el.attr("title"), tag_el.attr("rel").toLowerCase()) + "')"
})

</script>

{% endblock %}