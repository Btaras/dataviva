{% extends "templates/site.html" %}

{% block title %}: Generate a Guide{% endblock %}

{% block head %}

  <link type="text/css" rel="stylesheet" media="all" href="/static/css/utils/utils.selector.css" />
  <link type="text/css" rel="stylesheet" media="all" href="/static/css/libs/vizwhiz.d3.css" />

{% endblock %}

{% block js %}

  <script src="/static/js/utils/utils.selector.js"></script>

  <script>
  
  var current_path = [],
      lang = "{{ g.locale }}";

  function load_page(back) {
    
    if (d3.select("div#slide_container")[0][0]) {
      dataminas.slide.remove(back);
    }
    
    var url = null;
    if (current_path.length > 2 && current_path.length < 4) {
      if (current_path[0] == "location" && current_path[2] != "workforce") {
        url = "/guide/industry/";
      }
      else if (["location","industries","potential","wages"].indexOf(current_path[2]) >= 0 ||
              (["growth","paths"].indexOf(current_path[2]) >= 0  && current_path[0] == "career")) {
        url = "/guide/location/";
      }
    }
    else if (current_path.length < 4) {
      url = "/guide/"+current_path.join("/");
    }
    
    if (url) {
    
      // AJAX call to load new info
      d3.html(url+"?ajax=true", function(content){

        // Update URL
        var page_requested = current_path.length > 0 ? current_path.join("/")+"/" : "";
        var new_path = "/guide/"+page_requested;
        window.history.pushState({"html":'html',"pageTitle":'pageTitle'}, "", new_path);
        dataminas.breadcrumbs();
        dataminas.slide.load(content,back);
    
      })
      
    }
    else {
      window.location = "/guide/"+current_path.join("/")+"/";
    }
  
  }

  function update_path(id) {
    d3.event.preventDefault();
    current_path.push(id);
    load_page();
  }

  // Stuff to do only once, on page load
  window.onload = function(){
    
    if ("{{ category }}" != "None") {
      current_path.push("{{ category }}")
      if ("{{ category_id }}" != "None") {
        current_path.push("{{ category_id }}")
        if ("{{ option }}" != "None") {
          current_path.push("{{ option }}")
        }
      }
    }
  
    load_page();
  
  }  

  // Take control of the back button!
  var initial_load = true;
  window.onpopstate = function(event) {
    if(!initial_load){
      if (current_path.length == 0) {
        window.history.back();
      }
      else {
        current_path.pop();
        load_page(true);
      }
    }
    else {
      initial_load = false;
    }
  };

  </script>
  
{% endblock %}